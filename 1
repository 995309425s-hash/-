#!/bin/bash

# =================================================================
# 脚本名称: Linux系统综合管理脚本
# 支持系统: Rocky Linux 8/9/10, Ubuntu 22.04/24.04
# 功能: 桌面管理, 防火墙, 中文包, 换源, 系统升级, 初始化包, 网络配置
# =================================================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 检查是否为 root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}请使用 root 权限运行此脚本！${NC}"
  exit 1
fi

# --- 系统检测 ---
check_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VERSION_ID=$VERSION_ID
        CODENAME=$VERSION_CODENAME
    else
        echo -e "${RED}无法检测操作系统版本，脚本退出。${NC}"
        exit 1
    fi

    # 归一化 OS 名称
    if [[ "$OS" == "rocky" || "$OS" == "rhel" || "$OS" == "centos" ]]; then
        PKG_MANAGER="dnf"
        FAMILY="rhel"
        MAJOR_VER=$(echo $VERSION_ID | cut -d. -f1)
    elif [[ "$OS" == "ubuntu" ]]; then
        PKG_MANAGER="apt"
        FAMILY="debian"
    else
        echo -e "${RED}不支持的操作系统: $OS${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}检测到系统: $PRETTY_NAME ($FAMILY)${NC}"
}

# --- 1. 桌面图形安装与删除 ---
manage_desktop() {
    echo -e "\n${YELLOW}>>> 桌面图形环境管理${NC}"
    echo "1. 安装 GNOME 桌面环境"
    echo "2. 卸载/移除 桌面环境"
    read -p "请选择: " choice

    case $choice in
        1)
            echo "正在安装桌面环境..."
            if [ "$FAMILY" == "rhel" ]; then
                $PKG_MANAGER groupinstall -y "Server with GUI"
                systemctl set-default graphical
            elif [ "$FAMILY" == "debian" ]; then
                $PKG_MANAGER update
                $PKG_MANAGER install -y ubuntu-desktop
            fi
            echo -e "${GREEN}安装完成，请重启系统生效。${NC}"
            ;;
        2)
            echo "正在移除桌面环境..."
            if [ "$FAMILY" == "rhel" ]; then
                systemctl set-default multi-user.target
                $PKG_MANAGER groupremove -y "Server with GUI"
            elif [ "$FAMILY" == "debian" ]; then
                $PKG_MANAGER remove -y ubuntu-desktop gnome-shell
                $PKG_MANAGER autoremove -y
            fi
            echo -e "${GREEN}移除完成，已设置默认启动为命令行模式。${NC}"
            ;;
        *) echo -e "${RED}无效选择${NC}" ;;
    esac
}

# --- 2. 防火墙启动与停止 ---
manage_firewall() {
    echo -e "\n${YELLOW}>>> 防火墙管理${NC}"
    echo "1. 启动并开机自启"
    echo "2. 停止并禁用开机自启"
    echo "3. 查看状态"
    read -p "请选择: " choice

    # 确定服务名称
    if [ "$FAMILY" == "rhel" ]; then
        FW_SVC="firewalld"
    else
        FW_SVC="ufw"
    fi

    case $choice in
        1)
            if [ "$FAMILY" == "debian" ]; then ufw enable; else systemctl enable --now $FW_SVC; fi
            echo -e "${GREEN}防火墙已启动${NC}"
            ;;
        2)
            if [ "$FAMILY" == "debian" ]; then ufw disable; else systemctl disable --now $FW_SVC; fi
            echo -e "${GREEN}防火墙已停止${NC}"
            ;;
        3)
            if [ "$FAMILY" == "debian" ]; then ufw status; else systemctl status $FW_SVC; fi
            ;;
        *) echo -e "${RED}无效选择${NC}" ;;
    esac
}

# --- 3. 中文包安装与卸载 ---
manage_chinese() {
    echo -e "\n${YELLOW}>>> 中文环境与 Man 手册管理${NC}"
    echo "1. 安装中文语言包及中文 Man 手册"
    echo "2. 卸载中文支持"
    read -p "请选择: " choice

    case $choice in
        1)
            if [ "$FAMILY" == "rhel" ]; then
                $PKG_MANAGER install -y glibc-langpack-zh man-pages-zh-CN
                localectl set-locale LANG=zh_CN.UTF-8
            elif [ "$FAMILY" == "debian" ]; then
                $PKG_MANAGER install -y language-pack-zh-hans manpages-zh
                update-locale LANG=zh_CN.UTF-8
            fi
            echo -e "${GREEN}中文环境安装完毕，请重新登录生效。${NC}"
            ;;
        2)
            # 恢复英文
            localectl set-locale LANG=en_US.UTF-8
            if [ "$FAMILY" == "rhel" ]; then
                $PKG_MANAGER remove -y man-pages-zh-CN
            elif [ "$FAMILY" == "debian" ]; then
                $PKG_MANAGER remove -y manpages-zh
            fi
            echo -e "${GREEN}已恢复为英文环境 (zh_CN 语言包保留但不再作为默认)。${NC}"
            ;;
        *) echo -e "${RED}无效选择${NC}" ;;
    esac
}

# --- 4. 系统升级 ---
manage_upgrade() {
    echo -e "\n${YELLOW}>>> 系统升级管理${NC}"
    echo "1. 升级系统软件包 (Update/Upgrade)"
    echo "2. 升级至发行版稳定版本 (Dist-Upgrade/Distro-Sync)"
    read -p "请选择: " choice

    case $choice in
        1)
            if [ "$FAMILY" == "rhel" ]; then $PKG_MANAGER update -y; else $PKG_MANAGER update && $PKG_MANAGER upgrade -y; fi
            ;;
        2)
            if [ "$FAMILY" == "rhel" ]; then $PKG_MANAGER distro-sync -y; else $PKG_MANAGER update && $PKG_MANAGER dist-upgrade -y; fi
            ;;
        *) echo -e "${RED}无效选择${NC}" ;;
    esac
}

# --- 5. 初始化包选择 ---
manage_init_packages() {
    echo -e "\n${YELLOW}>>> 初始化常用软件包${NC}"
    echo "常用包列表: vim wget curl net-tools git unzip tar lrzsz"
    echo "1. 手动选择安装"
    echo "2. 手动选择卸载"
    read -p "请选择: " choice

    PACKAGES=("vim" "wget" "curl" "net-tools" "git" "unzip" "tar")
    # RHEL系 specific naming or extra
    if [ "$FAMILY" == "rhel" ]; then PACKAGES+=("lrzsz" "epel-release"); fi
    
    ACTION=""
    if [ "$choice" -eq 1 ]; then ACTION="install"; elif [ "$choice" -eq 2 ]; then ACTION="remove"; else return; fi

    for pkg in "${PACKAGES[@]}"; do
        read -p "是否 $ACTION $pkg? (y/n): " yn
        if [[ "$yn" =~ ^[Yy]$ ]]; then
            $PKG_MANAGER $ACTION -y $pkg
        fi
    done
}

# --- 6. 换源管理 ---
manage_repos() {
    echo -e "\n${YELLOW}>>> 软件源(Repo)管理${NC}"
    echo "1. 阿里云 (Aliyun)"
    echo "2. 腾讯云 (Tencent)"
    echo "3. 华为云 (Huawei)"
    echo "4. 清华大学 (Tsinghua)"
    echo "5. 南京大学 (NJU)"
    echo "6. 恢复官方默认源"
    read -p "请选择: " choice

    # 备份逻辑
    if [ ! -f /etc/repos.backup.flag ]; then
        echo "正在备份当前源..."
        if [ "$FAMILY" == "rhel" ]; then
            cp -r /etc/yum.repos.d /etc/yum.repos.d.bak
        elif [ "$FAMILY" == "debian" ]; then
            cp /etc/apt/sources.list /etc/apt/sources.list.bak
        fi
        touch /etc/repos.backup.flag
    fi

    # 定义 URL 基础部分
    case $choice in
        1) NAME="Aliyun"; URL_R="mirrors.aliyun.com"; URL_U="mirrors.aliyun.com";;
        2) NAME="Tencent"; URL_R="mirrors.cloud.tencent.com"; URL_U="mirrors.cloud.tencent.com";;
        3) NAME="Huawei"; URL_R="repo.huaweicloud.com"; URL_U="repo.huaweicloud.com";;
        4) NAME="Tsinghua"; URL_R="mirrors.tuna.tsinghua.edu.cn"; URL_U="mirrors.tuna.tsinghua.edu.cn";;
        5) NAME="NJU"; URL_R="mirrors.nju.edu.cn"; URL_U="mirrors.nju.edu.cn";;
        6) 
            echo "恢复默认源..."
            if [ "$FAMILY" == "rhel" ]; then
                rm -rf /etc/yum.repos.d
                cp -r /etc/yum.repos.d.bak /etc/yum.repos.d
            elif [ "$FAMILY" == "debian" ]; then
                cp /etc/apt/sources.list.bak /etc/apt/sources.list
            fi
            echo "已恢复。"; return ;;
        *) echo "无效选择"; return ;;
    esac

    echo "正在配置 $NAME 源..."

    if [ "$FAMILY" == "rhel" ]; then
        # Rocky Linux 处理
        # 简化处理：使用 sed 替换现有 repo 文件
        sed -e "s|^mirrorlist=|#mirrorlist=|g" \
            -e "s|^#baseurl=http://dl.rockylinux.org/\$contentdir|baseurl=https://$URL_R/rockylinux|g" \
            -i.bak /etc/yum.repos.d/rocky*.repo
        $PKG_MANAGER makecache
    elif [ "$FAMILY" == "debian" ]; then
        # Ubuntu 处理
        cat > /etc/apt/sources.list <<EOF
deb http://$URL_U/ubuntu/ $CODENAME main restricted universe multiverse
deb http://$URL_U/ubuntu/ $CODENAME-updates main restricted universe multiverse
deb http://$URL_U/ubuntu/ $CODENAME-backports main restricted universe multiverse
deb http://$URL_U/ubuntu/ $CODENAME-security main restricted universe multiverse
EOF
        $PKG_MANAGER update
    fi
    echo -e "${GREEN}换源完成 ($NAME)${NC}"
}

# --- 7. 网络配置 (重点) ---
manage_network() {
    echo -e "\n${YELLOW}>>> 网络配置管理 (NetworkManager)${NC}"
    
    # 1. 检查 IPv4
    echo "正在检查网络接口..."
    ip -4 a
    echo "------------------------"
    
    echo "请输入你要配置的网卡接口名称 (例如: ens33, eth0):"
    read -p "接口名: " IFACE_NAME

    # 检查接口是否存在
    if ! ip link show "$IFACE_NAME" > /dev/null 2>&1; then
        echo -e "${RED}错误: 接口 $IFACE_NAME 不存在。${NC}"
        return
    fi

    # 2. 获取输入信息
    read -p "请输入 IP 地址 (例如 192.168.1.100): " IP_ADDR
    read -p "请输入 子网掩码/前缀 (例如 24 或 255.255.255.0): " NETMASK
    
    # 如果输入的是 255.255.255.0 格式，简单转换为前缀(简化逻辑，通常建议直接输 24)
    if [[ "$NETMASK" == *"."* ]]; then
        # 这里仅作简单处理，建议用户输入CIDR格式
        echo -e "${YELLOW}注意: 建议使用 CIDR 格式 (如 24)。尝试使用 24...${NC}"
        PREFIX=24
    else
        PREFIX=$NETMASK
    fi

    read -p "请输入 网关地址 (例如 192.168.1.1): " GATEWAY
    read -p "请输入 DNS 地址 (多个用分号隔开, 例如 8.8.8.8;114.114.114.114): " DNS_INPUT
    
    # 3. 生成 NetworkManager 配置文件 (Keyfile 格式)
    # Rocky 和 新版 Ubuntu 均支持 Keyfile 格式在 /etc/NetworkManager/system-connections/
    
    NM_FILE="/etc/NetworkManager/system-connections/${IFACE_NAME}-manual.nmconnection"
    
    echo "正在生成 NetworkManager 配置文件: $NM_FILE"
    
    # 确保目录权限安全
    chmod 600 "$NM_FILE" 2>/dev/null

    cat > "$NM_FILE" <<EOF
[connection]
id=${IFACE_NAME}-manual
uuid=$(uuidgen)
type=ethernet
interface-name=${IFACE_NAME}
permissions=

[ethernet]
mac-address-blacklist=

[ipv4]
address1=${IP_ADDR}/${PREFIX},${GATEWAY}
dns=${DNS_INPUT};
method=manual

[ipv6]
addr-gen-mode=stable-privacy
method=auto

[proxy]
EOF
    
    chmod 600 "$NM_FILE"
    
    echo -e "${GREEN}配置文件已写入。${NC}"
    echo "正在重载 NetworkManager..."
    nmcli connection reload
    nmcli connection up "${IFACE_NAME}-manual"
    
    echo -e "${GREEN}网络配置已应用。当前IP信息:${NC}"
    ip -4 a show "$IFACE_NAME"
}

# --- 8. 强制修改网卡名称 ---
force_rename_nic() {
    echo -e "\n${YELLOW}>>> 强制修改网卡名称${NC}"
    echo -e "${RED}警告: 修改网卡名称可能导致网络断开，需重启生效。${NC}"
    
    # 列出当前网卡和MAC
    ip link show | awk '/ether/ {print $2}'
    echo "------------------------"
    
    read -p "请输入网卡的 MAC 地址 (例如 00:0c:29:xx:xx:xx): " MAC_ADDR
    read -p "请输入新的网卡名称 (例如 eth0): " NEW_NAME
    
    RULES_FILE="/etc/udev/rules.d/70-persistent-net.rules"
    
    echo "正在写入 udev 规则到 $RULES_FILE..."
    echo "SUBSYSTEM==\"net\", ACTION==\"add\", DRIVERS==\"?*\", ATTR{address}==\"$MAC_ADDR\", NAME=\"$NEW_NAME\"" > $RULES_FILE
    
    # 修改 Grub (针对 RHEL/Rocky 需要禁用 biosdevname)
    if [ "$FAMILY" == "rhel" ]; then
        echo "更新 Grub 配置以支持传统命名..."
        # 检查是否已经存在参数，避免重复添加
        if ! grep -q "net.ifnames=0" /etc/default/grub; then
            sed -i 's/GRUB_CMDLINE_LINUX="/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 /' /etc/default/grub
            grub2-mkconfig -o /boot/grub2/grub.cfg
        fi
    elif [ "$FAMILY" == "debian" ]; then
         if ! grep -q "net.ifnames=0" /etc/default/grub; then
            sed -i 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"/' /etc/default/grub
            update-grub
        fi
    fi
    
    echo -e "${GREEN}配置完成。请重启系统以生效: reboot${NC}"
}

# --- 主菜单 ---
check_os

while true; do
    echo -e "\n========================================"
    echo -e "   Linux 系统综合管理工具 ($OS $VERSION_ID)"
    echo "========================================"
    echo "1. 桌面图形环境安装与删除"
    echo "2. 防火墙启动与停止"
    echo "3. 中文包安装(Man+命令)与卸载"
    echo "4. 系统包升级与稳定包升级"
    echo "5. 初始化常用包 (安装/卸载)"
    echo "6. 更换软件源 (阿里/腾讯/华为等)"
    echo "7. 网络配置 (手动IP/网关/生成NM文件)"
    echo "8. 强制修改网卡名称 (udev)"
    echo "0. 退出"
    echo "========================================"
    read -p "请输入选项 [0-8]: " choice

    case $choice in
        1) manage_desktop ;;
        2) manage_firewall ;;
        3) manage_chinese ;;
        4) manage_upgrade ;;
        5) manage_init_packages ;;
        6) manage_repos ;;
        7) manage_network ;;
        8) force_rename_nic ;;
        0) echo "退出脚本。"; exit 0 ;;
        *) echo -e "${RED}无效输入，请重试。${NC}" ;;
    esac
done
